function convert_num2dayval(e){switch(e){case"1":return 2;case"2":return 3;case"3":return 4;case"4":return 5;case"5":return 6;case"6":return 7;case"0":return 8;default:return!1}}function convert_Min2Hour(e){if(e=parseInt(e),!(1>e)){var t=Math.floor(e/60),n=e%60;10>t&&(t="0"+t),10>n&&(n="0"+n);var a=t+":"+n;return a}}function convert_Hour2Min(e){var t=null,n=null,a=null,i=null;return t=e.split(":"),n=parseInt(t[0]),a=parseInt(t[1]),i=60*n+a}var Calendar=function(){var e=$("#confirmedAppointment_modal"),t=($("#confirmedAppointment_form"),e.find(".edit_appointment_action")),n=e.find(".delete_appointment_action"),a=e.find(".complete_appointment_action"),i=$("#editConfirmedAppointment_modal"),r=$("#editConfirmedAppointment_form"),d=$("#addAppointment_modal"),o=$("#addAppointment_form"),_=function(){var i=new Date;i.setDate(i.getDate()-1),$("#calendar").fullCalendar({header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},disableDragging:!0,defaultDate:moment(),editable:!0,eventLimit:!0,events:{url:URL+"spaCMS/calendar/xhrGet_calendar",error:function(){$("#script-warning").show()}},loading:function(e){$("#loading").toggle(e)},dayClick:function(e){o[0].reset();var t=$("input[name=appointment_date]",d),n=d.find(".appointment_date"),a=$("input[name=appointment_created]",d),i=convert_num2dayval(e.format("d")),r=null,_=null,c=null,l=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(l,function(d){return r=d[i][0],_=d[i][1],c=d[i][2],r?(f(),t.val(e.format()),n.val(e.format("DD/MM/YYYY")),void a.val(e.format())):(alert("Không có lịch làm việc vào ngày này!"),!1)},"json").done(function(){r&&d.modal("show")});var p=d.find(".list_gus"),s=d.find(".appointment_time_start"),u=d.find(".user_service_duration"),m=$("input[name=appointment_price]",d),h=$("input[name=appointment_time_end]",d),v=d.find(".appointment_time_end");p.change(function(){var t=$(this),n=t.val(),a=null,i=null,r=null,d=null,o='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',l="";if(""===n)return!1;var p=URL+"spaCMS/calendar/xhrGet_user_service";$.get(p,{user_service_id:n},function(t){i=""!==t[0].user_service_sale_price?t[0].user_service_sale_price:t[0].user_service_full_price,a=t[0].user_service_duration,a=parseInt(a),s.html("");var p=60*_,u=60*c,m=p,f=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(f,{us_id:n,date:e.format()},function(e){for(;u>m;){var t=!1;$.each(e,function(e,n){var a=convert_Hour2Min(n.schedule_time_start),i=convert_Hour2Min(n.schedule_time_end);m>=a&&i>m&&(t=!0)}),timeStart_hourValue=convert_Min2Hour(m),l+=o.replace(/:appointment_time_start/g,timeStart_hourValue),l=t?l.replace(":isScheduled",'disabled="disabled"'):l.replace(":isScheduled",""),m+=a}},"json").done(function(){s.html(l)}),d=p,r=convert_Min2Hour(d+a)},"json").done(function(){u.text(a),v.text(r),h.val(r),m.val(i)})})},eventClick:function(i){var r=e.find(".weekday"),d=e.find(".day"),o=e.find(".month"),_=e.find(".year"),c=e.find(".time"),l=e.find(".user_service_name"),p=e.find(".user_service_duration"),s=e.find(".user_service_price"),u=e.find(".status-unpaid"),m=e.find(".status-prepaid"),f=e.find(".status-paid"),h=e.find(".status-uncomplete"),v=e.find(".status-complete"),g=e.find(".client_name"),x=e.find(".client_phone"),C=e.find(".client_email"),M=e.find(".client_note"),y=e.find(".appointment_created"),S=null,U=null,b=null;return i.a_id&&(U=i.a_id,b="appointment",S=URL+"spaCMS/calendar/xhrGet_appointment"),i.b_id&&(U=i.b_id,b="booking_detail",S=URL+"spaCMS/calendar/xhrGet_booking"),$.get(S,{data_id:U},function(i){"undefined"==typeof i[0]&&console.log("Không có data, có lẽ dữ liệu vào khiến sql gặp vấn đề"),console.log(i);var $=new Date(i[0].data_date);r.text("Thứ "+($.getDay()+1)),d.text($.getDate()),o.text($.getMonth()+1),_.text($.getFullYear()),c.text(i[0].data_time_start),l.text(i[0].data_us_name),p.text(i[0].data_us_duration+" phút"),s.text(i[0].data_price+" đ"),x.text(""!==i[0].data_client_phone?i[0].data_client_phone:"Chưa có số điện thoại"),g.text(i[0].data_client_name),x.text(i[0].data_client_phone),C.text(i[0].data_client_email),M.text(i[0].data_client_note),"1"==i[0].data_status?(v.show(),h.hide()):(v.hide(),h.show()),"appointment"==b&&(u.hide(),m.hide(),f.show()),"booking_detail"==b&&(u.hide(),m.show(),f.hide());var S=e.find(".btnAct_confirm_appointment"),U=e.find(".is_confirm_0"),w=e.find(".is_confirm_1");1==i[0].data_is_confirm?(U.hide(),w.show(),S.hide()):(U.show(),w.hide(),S.show()),1==i[0].data_status?(a.hide(),t.hide(),S.hide()):(a.show(),S.show(),t.show()),y.text(i[0].data_created),t.attr("data_id",i[0].data_id),t.attr("data_type",b),n.attr("data_id",i[0].data_id),n.attr("data_type",b),a.attr("data_id",i[0].data_id),a.attr("data_type",b),S.attr("data_id",i[0].data_id),S.attr("data_type",b)},"json").done(function(){e.modal("show")}),!1},dayRender:function(e,t){i>e&&t.css("background-color","#F0F0F0")}})},c=function(){o.on("submit",function(){var e=$(this),t=e.serialize(),n=!1,a=e.find(".loading"),i=e.find(".done");a.fadeIn(),i.hide();var r=URL+"spaCMS/calendar/xhrInsert_appointment";return $.post(r,t,function(e){"success"==e&&(n=!0,$("#calendar").fullCalendar("refetchEvents"))}).done(function(){a.hide(),i.show(),n?d.modal("hide"):alert("insert appointment error!")}),!1})},l=function(){t.on("click",function(){var e=$(this),t=e.attr("data_id"),n=e.attr("data_type"),a=!1,d=e.find(".loading"),o=e.find(".done");d.fadeIn(),o.hide();var _=null;return"appointment"==n?_=URL+"spaCMS/calendar/xhrGet_appointment":"booking_detail"==n&&(_=URL+"spaCMS/calendar/xhrGet_booking"),$.get(_,{data_id:t},function(e){if(0==e.length)return!1;a=!0;var d=$(".edit_client_action"),o=null,_=i.find(".client_name"),c=i.find(".client_phone"),l=i.find(".client_note"),p=$("select[name=user_service_service_id]",i),s=$("input[name=appointment_price]",i),u=$("input[name=appointment_date]",i),m=i.find(".appointment_date"),h=$("select[name=appointment_time_start]",i),v=$("input[name=appointment_time_end]",i),g=i.find(".appointment_time_end"),x=i.find(".user_service_duration"),C=i.find(".appointment_note"),M=f();M.done(function(){p.find('option[value="'+e[0].data_us_id+'"]').prop("selected",!0)}),_.text(e[0].data_client_name),c.text(e[0].data_client_phone),l.text(e[0].data_client_note),s.val(e[0].data_price),u.val(e[0].data_date),m.val(e[0].data_date),h.val(e[0].data_time_start),v.val(e[0].data_time_end),g.text(e[0].data_time_end),x.text(e[0].data_us_duration),C.text(e[0].data_note),"appointment"==n?(o=e[0].data_id,d.attr("data_id",o),d.attr("data_type",n)):d.hide(),$("input[name=data_id]",r).val(t),$("input[name=data_type]",r).val(n);var y=i.find(".list_gus"),S=i.find(".appointment_time_start"),U=i.find(".user_service_duration"),b=$("input[name=appointment_price]",i),w=$("input[name=appointment_time_end]",i),I=i.find(".appointment_time_end"),L=$("input[name=appointment_date]",i).val(),R=moment(L,"YYYY-MM-DD"),k=convert_num2dayval(R.format("d")),D=null,G=null,H=null,A=URL+"spaCMS/calendar/xhrGet_user_open_hour";$.get(A,function(e){D=e[k][0],G=e[k][1],H=e[k][2]},"json"),y.change(function(){var e=$(this),t=e.val(),n=null,a=null,i=null,r=null,d='<option value=":appointment_time_start" :isScheduled>:appointment_time_start</option>',o="";if(""===t)return!1;var _=URL+"spaCMS/calendar/xhrGet_user_service";$.get(_,{user_service_id:t},function(e){a=""!==e[0].user_service_sale_price?e[0].user_service_sale_price:e[0].user_service_full_price,n=e[0].user_service_duration,n=parseInt(n),S.html("");var _=60*G,c=60*H,l=_,p=URL+"spaCMS/calendar/xhrGet_appointment_confirmed";$.get(p,{us_id:t,date:R.format()},function(e){for(console.log(e);c>l;){var t=!1;$.each(e,function(e,n){var a=convert_Hour2Min(n.schedule_time_start),i=convert_Hour2Min(n.schedule_time_end);l>=a&&i>l&&(t=!0)}),timeStart_hourValue=convert_Min2Hour(l),o+=d.replace(/:appointment_time_start/g,timeStart_hourValue),o=t?o.replace(":isScheduled",'disabled="disabled"'):o.replace(":isScheduled",""),l+=n}},"json").done(function(){S.html(o)}),r=_,i=convert_Min2Hour(r+n)},"json").done(function(){U.text(n),I.text(i),w.val(i),b.val(a)})})},"json").done(function(){d.hide(),o.fadeIn(),a?i.modal("show"):alert("Open editConfirmedAppointment popup error!")}),!1});var e=i.find(".appointment_time_start");e.change(function(){var e=$(this),t=e.val(),n=null,a=i.find(".user_service_duration").text();a=parseInt(a),t=convert_Hour2Min(t),n=t+a,n=convert_Min2Hour(n);var r=i.find(".appointment_time_end");r.text(n),$("input[name=appointment_time_end]",i).val(n)})},p=function(){r.on("submit",function(){var t=$(this),n=t.serialize(),a=(t.find(".b-service-not-exist"),!1),r=t.find(".loading"),d=t.find(".done");r.fadeIn(),d.hide();var o=URL+"spaCMS/calendar/xhrUpdate_appointment";return $.post(o,n,function(e){"success"==e&&($("#calendar").fullCalendar("refetchEvents"),a=!0)}).done(function(){r.hide(),d.show(),a?(i.modal("hide"),e.modal("hide"),alert("Cập nhật lịch hẹn thành công!")):alert("Update appointment error!")}),!1});var n=e.find(".btnAct_confirm_appointment");n.on("click",function(){if(confirm("Xác thực lịch hẹn này?")){var t=$(this),a=e.find(".is_confirm_0"),i=e.find(".is_confirm_1"),r=!1,d=t.find(".loading"),o=t.find(".done");d.fadeIn(),o.hide();var _=t.attr("data_id"),c=t.attr("data_type"),l=URL+"spaCMS/calendar/xhrUpdate_appointment_is_confirm";$.post(l,{data_id:_,data_type:c},function(e){"success"==e&&(r=!0)}).done(function(){d.hide(),o.show(),r?(a.hide(),i.hide(),i.fadeIn(),n.fadeOut()):alert("Confirmed appointment error!")})}}),a.on("click",function(){if(confirm("Bạn có chắc đã hoàn thành lịch hẹn này?")){var i=$(this),r=i.attr("data_id"),d=i.attr("data_type"),o=!1,_=i.find(".loading"),c=i.find(".done");_.fadeIn(),c.hide();var l=!1,p=URL+"spaCMS/calendar/xhrCheck_appointment_is_confirmed";$.post(p,{data_id:r,data_type:d},function(i){if("success"!=i)return!1;l=!0;var _=e.find(".status-uncomplete"),c=e.find(".status-complete"),p=URL+"spaCMS/calendar/xhrUpdate_appointment_status";$.post(p,{data_id:r,data_type:d},function(e){"success"==e&&($("#calendar").fullCalendar("refetchEvents"),o=!0)}).done(function(){o?(_.hide(),c.fadeIn(),a.fadeOut(),t.fadeOut(),t.fadeOut(),n.hide()):(_.fadeIn(),c.hide(),alert("Update appointment status error"))})}).done(function(){return _.hide(),c.show(),0==l?(alert("Chưa thể hoàn thành khi lịch hẹn của bạn chưa được xác thực!"),!1):void 0})}return!1})},s=function(){n.on("click",function(){if(confirm("Bạn có chắc sẽ hủy lịch hẹn này?")){var t=$(this),n=t.attr("data_id"),a=t.attr("data_type"),i=!1,r=t.find(".loading"),d=t.find(".done");r.fadeIn(),d.hide();var o=URL+"spaCMS/calendar/xhrDelete_appointment";$.post(o,{data_id:n,data_type:a},function(e){"success"==e&&($("#calendar").fullCalendar("refetchEvents"),i=!0)}).done(function(){r.hide(),d.show(),i?e.modal("hide"):alert("Can not cancel appointment!")})}return!1})},u=function(){var e=$("#editConfirmedAppointment_form").find(".edit_client_action"),t=$("#editClient_modal");e.on("click",function(){var e=$(this),n=e.attr("data_id"),a=e.attr("data_type"),i=e.find(".e-loading");i.fadeIn();var r=null;return"appointment"==a?r=URL+"spaCMS/calendar/xhrGet_appointment":"booking_detail"==a&&(r=URL+"spaCMS/calendar/xhrGet_booking"),$.get(r,{data_id:n},function(e){var i=$("input[name=client_name]",t),r=$("input[name=client_phone]",t),d=$("input[name=client_email]",t),o=$("input[name=client_sex]",t),_=$("input[name=client_birthYear]",t),c=$("textarea[name=client_note]",t);i.val(e[0].data_client_name),r.val(e[0].data_client_phone),d.val(e[0].data_client_email),o.val(e[0].data_client_sex),_.val(e[0].data_client_birth),c.val(e[0].data_client_note),$("input[name=data_id]",t).val(n),$("input[name=data_type]",t).val(a)},"json").done(function(){i.hide(),t.modal("show")}),!1})},m=function(){var e=$("#editClient_modal"),t=$("#editConfirmedAppointment_form"),n=t.find(".client_name"),a=t.find(".client_phone"),i=t.find(".client_note");$("#editClient_form").on("submit",function(){var t=$(this),r=t.serialize(),d=!1,o=t.find(".loading"),_=t.find(".done");o.fadeIn(),_.hide();var c=URL+"spaCMS/calendar/xhrUpdate_appointment_client";return $.post(c,r,function(t){"success"==t&&($("#calendar").fullCalendar("refetchEvents"),n.hide(),a.hide(),i.hide(),n.text($("input[name=client_name]",e).val()),a.text($("input[name=client_phone]",e).val()),i.text($("textarea[name=client_note]",e).val()),n.fadeIn(),a.fadeIn(),i.fadeIn(),d=!0)}).done(function(){o.hide(),_.show(),d?e.modal("hide"):alert("Update client error!")}),!1})},f=function(){var e=$(".list_gus");e.html('<option value="">Chọn dịch vụ</option>');var t='<optgroup data-id=":group_service_id" label=":group_service_name">';t+=":list_user_service",t+="</optgroup>";var n='<option value=":user_service_id">:user_service_name</option>';n+=":list_user_service";var a=URL+"spaCMS/menu/xhrGet_group_user_service",i="",r=$.get(a,function(a){$.each(a,function(a,r){i=t.replace(":group_service_id",r.group_service_id),i=i.replace(":group_service_name",r.group_service_name),"undefined"!=typeof r.list_user_service&&$.each(r.list_user_service,function(e,t){i=i.replace(":list_user_service",n),i=i.replace(":user_service_id",t.user_service_id),i=i.replace(":user_service_name",t.user_service_name)}),i=i.replace(":list_user_service",""),e.append(i)})},"json");return r};return{init:function(){_(),c(),s(),l(),p(),u(),m()}}}();$(document).ready(function(){$(".appointment_time_start").change(function(){var e=$(this),t=e.val(),n=null,a=$("#addAppointment_form .user_service_duration").text();a=parseInt(a),t=convert_Hour2Min(t),n=t+a,n=convert_Min2Hour(n);var i=$("#addAppointment_modal"),r=i.find(".appointment_time_end");r.text(n),$("input[name=appointment_time_end]",i).val(n)})}),Calendar.init();